# 4. 통합테스트

## 4-1 통합테스트란 무엇인가

단위 테스트의 한계 => 독립된 일부 모듈만 테스트하기 때문에 여러 모듈이 조합되었을 때의 동작은 검증할 수 없음

- 통합테스트는 두개 이상의 모듈이 상호작용하여 발생하는 상태를 검증
- 실제 앱의 비즈니스 로직과 가깝게 기능을 검증할 수 있다.

**모듈 간에 발생하는 에러 검증**

단순 UI 렌더링 및 간단한 로직을 실행하는 컴포넌트가 제대로 렌더링 되는지 한번에 효율적으로 검증가능

상태나 데이터를 관리하는 특정 컴포넌트를 기준으로 하위 컴포넌트가 제대로 렌더링 되는지 검증하는 테스트 => 구조적인 설계가 중요함.

**즉 통합 테스트를 잘 작성하기 위해서는 좋은 설계까 기반이 되어야 한다**

## 4.2 통합 테스트 대상 선정하기

주로 컴포넌트간의 상호작용, API 호출 및 상태 변경에 따른 UI 변경 사항 검증

다양한 기능 검증을 위한 API, 상태 관리 스토어 모킹 필요!!

비즈니스 로직은 프로그램의 핵심 기능을 구현하는 코드

비즈니스 로직을 통해 서비스의 정책, 절차, 규칙 등을 코드로 구현

해당 페이지에서 비즈니스 로직은

1. 네비게이션바
2. 상품검색 영역
3. 상품 리스트 영역

=> 테스트의 범위를 잘 나누어야 한다!

## 4.3 상태 관리 모킹하기

zustand 모킹 방법

- zustand.js를 통해 자동 모킹을 적용해 스토어를 초기화
- mockZustandStore의 유틸 함수를 통한 zustand 스토어의 상태 변경
- React Redux나 Recoil과 같은 상태 관리 라이브러리도 모킹 가이드를 제공

## 4.4 통합 테스트 작성하기 - 상태 관리 모킹

- user.clear, user.type
- within
- vi.fn()
- vi.stubGlobal('alert', alertSpy);
- toHaveBeenNthCalledWith
- queryByText 요소의 존재유무 판단. 요소가 존재하지 않아도 에러 X, getBy는 요소 존재하면 에러를 던짐

## 4.5 msw로 API 모킹하기

- 테스트에서 API 호출 => 실행 시간 증가, 서버 이슈로 인한 테스트 실패
- API 응답 모킹 => 일관된 테스트 환경 구성 가능
- 모든 API 호출 => Tanstack query에서 담당 => 테스트 설정 필요

render 함수를 queryClientProvider로 감싸기

- retry 옵션은 false로 => 너무 오래걸리면 이슈
- Mock Service Worker => 브라우저, nodejs 환경에서 모듈의 요청을 가로채어 모킹

- resetHandlers() 런타임에 변경한 msw의 모킹을 초기화

## 4.6 RTL 비동기 유틸 함수를 통한 노출 테스트 작성

- forEach로 반복 작업 줄이기
- 테스트 코드는 일반적으로 동기적임. 비동기 처리를 위해 findBy 사용(getBy, queryBy와 비슷하나 비동기 처리시 사용)
- toHaveBeenNthCalledWith

- handlers.js에서 모킹 데이터 기준으로 상품 목록 API의 페이징 응답 결과를 반환

- findBy 쿼리
  - 쿼리가 통과하거나 시간 초과될 때 까지 재시도한다
  - API 호출과 같은 비동기 처리로 인한 변화를 감지해야 할 때 사용하기 좋다.
  - RTL에서는 findBy 같은 비동기 메서드의 반환값은 Promise이기에, 해당 요소를 사용하려면 await, then을 사용해야 한다.

## 총평..

실제로 사용할 함수나 테스트 방식들이 많다. 아직 생소해서 익숙하지 않고 어렵다. 추후 충분히 반복 숙달하여 내 것으로 만들어야할 페이지!

- 바로 타이핑 하기 보다는 문제만 보고 나만의 답을 적어본 후 답을 보는 방식으로 학습 추천
